<?php

/**
 * @file
 *   Provides a simple means of associating a user with taxonomy terms.
 */


define('USER_TERMS_GROUP_TITLE', t('User terms'));


/**
 * Implementation of hook_help().
 */
function user_terms_help($path, $arg) {
  switch ($path) {
    case 'admin/help#user_terms':
      return t("<p>The user terms module allows you to apply vocabularies to users. Users may then select terms from these vocabularies on either their account edit page or Profile modules category pages, and thus tag themselves in the same way as nodes.</p>");
    case 'admin/user/user_terms':
      return t("<p>Choose which vocabularies to apply to user accounts, where users select terms from these, and the manner in which they are displayed on the user account page.</p>");
  }
}


/**
 * Implementation of hook_menu().
 */
function user_terms_menu() {
  $items = array();

  $items['admin/user/user_terms'] = array(
    'title'             => 'User terms',
    'page callback'     => 'drupal_get_form',
    'page arguments'    => array('user_terms_settings'),
    'file'              => 'user_terms.admin.inc',
    'access arguments'  => array('administer users'),
    'type'              => MENU_NORMAL_ITEM,
    'description'       => 'Configure user terms vocabulary settings.',
  );

  return $items;
}


/**
 * Implementation of hook_user().
 */
function user_terms_user($op, &$edit, &$account, $category = NULL) {
  switch ($op) {
    // The user account is being loaded.
    case 'load':
      return user_terms_load_profile($account);

    // The user account registration form is about to be displayed. 
    // The module should present the form elements it wishes to inject into the form.
    case 'register':
      return user_terms_form_profile($edit, $account, $category, TRUE);

    // The user account is being added. 
    // The module should save its custom additions to the user object into the 
    // database and set the saved fields to NULL in $edit.
    case 'insert':
      user_terms_save_profile($edit, $account, $category, TRUE);
      break;

    // The user's account information is being displayed.
    // The module should format its custom additions for display, 
    // and add them to the $account->content array.
    case 'view':
      return user_terms_view_profile($account);

    // The user account edit form is about to be displayed.
    // The module should present the form elements it wishes to inject into the form.
    case 'form':
      return user_terms_form_profile($edit, $account, $category);

    // The user account is being changed. 
    // The module should save its custom additions to the user object into the 
    // database and set the saved fields to NULL in $edit.
    // TODO: This method doesn't seem to work because it's stored on a page generated by profile.module
    case 'update':
      return user_terms_save_profile($edit, $account, $category);

    // The user account is being deleted. 
    // The module should remove its custom additions to the user object from the database. 
    case 'delete':
      db_query('DELETE FROM {term_user} WHERE uid = %d', $account->uid);
  }
}


/**
 * Load the user's profile.
 *
 * @param &$account
 *   The account from which data is loaded.
 */
function user_terms_load_profile(&$account) {
  // Implement our own static caching of account data, because core doesn't
  // have any, and causes us to come here multiple times when viewing an 
  // account. @see http://drupal.org/node/685806.
  static $user_terms = array();
  if (isset($user_terms[$account->uid])) {
    $account->user_terms = $user_terms[$account->uid];
    return;
  }

  $terms  = array();
  $query = "SELECT u.tid, t.vid, t.name FROM {term_user} u 
              INNER JOIN {term_data} t ON t.tid = u.tid 
              INNER JOIN {vocabulary} v ON t.vid = v.vid 
              WHERE u.uid = %d
              ORDER BY v.weight, t.weight, t.name";
  $result = db_query($query, $account->uid);

  while ($term = db_fetch_array($result)) {
    $terms[$term['tid']] = $term;
  }

  $user_terms[$account->uid] = $account->user_terms = $terms;
}


/**
 * View the user's profile.
 *
 * @param &$account
 *   The account from which data is loaded and displayed.
 */
function user_terms_view_profile(&$account) {
  $vids = variable_get('user_terms_vocabs', array());

  // Skip everything if no user term vocabulary is selected or
  // the user has no terms.
  if (!empty($vids) && !empty($account->user_terms)) {
    
    // Create the main profile category.
    $account->content['user_terms'] = array(
      '#type' => 'user_profile_category',
      '#title' => t('User terms'),
      '#weight' => 4,
      // Term and vocabulary names should be hidden from users without the 
      // basic 'access content' permission.
      '#access' => user_access('access content'),
    );
    
    // Should terms be grouped?
    if (variable_get('user_terms_group_terms', FALSE)) {
      user_terms_view_profile_grouped($account, $vids);
    }
    else {
      user_terms_view_profile_separated($account, $vids);
    }
  }
}

/**
 * Show terms on the user's profile as a single group.
 */
function user_terms_view_profile_grouped(&$account, $vids) {
  $terms = $account->user_terms;
  $term_names = array();

  foreach ($terms as $tid => $term) {
    // Check if each term's vocab is actually enabled
    if (in_array($term['vid'], $vids)) {
      $term_names[] = check_plain($terms[$tid]['name']);
    }
  }

  if (!empty($term_names)) {
    user_terms_view_profile_item($account, 'user_terms', variable_get('user_terms_group_title', USER_TERMS_GROUP_TITLE), $term_names);
  }
}


/**
 * Show terms on the user's profile by vocabulary.
 */
function user_terms_view_profile_separated(&$account, $vids) {
  $terms = $account->user_terms;

  foreach ($vids as $vid) {

    $term_names = array();
    
    foreach ($terms as $tid => $term) {
      if ($term['vid'] == $vid) {
        $term_names[] = check_plain($terms[$tid]['name']);
        unset($terms[$tid]);
      }
    }

    if (!empty($term_names)) {
      $vocab = taxonomy_vocabulary_load($vid);
      user_terms_view_profile_item($account, 'user_terms_' . $vid, $vocab->name, $term_names, $vocab->weight);
    }
  }
}

/**
 * Add a single profile item of taxonomy terms to the user account.
 */
function user_terms_view_profile_item(&$account, $item_key, $item_title, $term_names, $weight = 0) {
  // Provide a default title if one doesn't exist
  if (empty($item_title)) {
    $item_title = t('User terms');
  }

  $account->content['user_terms'][$item_key] = array(
    '#type' => 'user_profile_item',
    '#title' => check_plain($item_title),
    '#value' => theme('item_list', $term_names),
    '#weight' => $weight,
  );
}


/**
 * Edit a user's profile or register a new account.
 *
 * Helper for hook_user ops register / form.
 *
 * @param &$edit
 *   The array of form values submitted by the user.
 * @param &$account
 *   The account from which data is loaded and displayed.
 * @param $category
 *   The active category of user information being edited.
 * @param $register
 *   Whether we are on the user registration form.
 */
function user_terms_form_profile($edit, $account, $category, $register = FALSE) {
  // Check for user_terms_override_selector, so other modules can intercept 
  // before hook_form_alter and provide scalable alternatives.
  // This is the same approach as taxonomy_form_alter().
  if (!variable_get('user_terms_override_selector', FALSE)) {
    $form  = array();
    $vids = variable_get('user_terms_vocabs', array());
    if ($register) {
      $vids = variable_get('user_terms_vocabs_register', array());
    }

    // Note that even without profile module, $category is set.
    if ($category) {
      // Determine which vocabularies should be shown in the form.
      $vids_path = variable_get('user_terms_vocabs_path', array());
      foreach ($vids as $vid) {
        if ($vids_path[$vid] != $category) {
          unset($vids[$vid]);
        }
      }
    }

    // Skip everything if no user term vocabulary is selected.
    if (!empty($vids)) {
      $form['user_terms'] = array(
        '#type' => 'fieldset',
        '#title' => check_plain(variable_get('user_terms_group_title', USER_TERMS_GROUP_TITLE)),
        // Term and vocabulary names should be hidden from users without the 
        // basic 'access content' permission.
        '#access' => user_access('access content'),
      );
      
      // Set a hidden value on the form listing the vocabularies we are editing
      // here, so that we can check in user_terms_save_profile() and avoid
      // clobbering terms from other vocabularies.
      // This is an array whose keys are the vids, and values are either also
      // the $vid, or the string 'tags' if the particular vocabulary is tags, ie:
      //    $vid => (either $vid or 'tags')
      $form['user_terms_vids'] = array(
        '#type' => 'value', 
        '#value' => array(), // We will fill this in as we handle each vocab.
      );      

      foreach ($vids as $vid)  {
        $vocabulary = taxonomy_vocabulary_load($vid);

        // Tags need special handling.
        if ($vocabulary->tags) {
          $default_terms = array();
          if (isset($account->user_terms)) {
            foreach ($account->user_terms as $term) {
              if (isset($term['vid']) && $term['vid'] == $vid) {
                $default_terms[] = $term['name'];
              }
            }
          }

          if ($vocabulary->help) {
            $help = filter_xss_admin($vocabulary->help);
          }
          else {
            $help = t('A comma-separated list of terms describing this content. Example: funny, bungee jumping, "Company, Inc.".');
          }
   
          $form['user_terms']['user_terms_' . $vocabulary->vid] = array('#type' => 'textfield',
            '#title' => check_plain($vocabulary->name),
            '#description' => $help,
            '#default_value' => $default_terms ? implode(', ', $default_terms) : '',
            '#autocomplete_path' => 'taxonomy/autocomplete/' . $vocabulary->vid,
            '#weight' => $vocabulary->weight,
            '#maxlength' => 1024,
          );
          
          // Add this vid to the hidden value, indicating it uses tags.
          $form['user_terms_vids']['#value'][$vid] = 'tags';
        }
        else {
          $default_terms = array();
          if (isset($account->user_terms)) {
            foreach ($account->user_terms as $term) {
              if (isset($term['vid']) && $term['vid'] == $vid) {
                $default_terms[$term['tid']] = $term;
              }
            }
          }
          
          // Use taxonomy module's form element builder function.
          $form['user_terms']['user_terms_' . $vid]  = taxonomy_form($vid, array_keys($default_terms), NULL, 'taxonomy');
          $form['user_terms']['user_terms_' . $vid]['#weight'] = $vocabulary->weight;
          $form['user_terms']['user_terms_' . $vid]['#required'] = $vocabulary->required;
          
          // Add this vid to the hidden value.
          $form['user_terms_vids']['#value'][$vid] = $vid;
        }
      }

      return $form;
    }
  }
}


/**
 * Save a user's profile or register a new account.
 *
 * @param &$account
 *   The account from which data is loaded and displayed.
 */
function user_terms_save_profile(&$edit, &$account, $category, $register = FALSE) {
  // Check for the presence of our hidden value set in user_terms_form_profile().
  // If it is not set, then we have come here from something that is not a 
  // user edit form, eg a user admin operation such as 'block user', and
  // have no data about user terms to save. Leave now!
  if (!isset($edit['user_terms_vids'])) {
    return; 
  }

  $edited_vids = array_keys($edit['user_terms_vids']);
  $vids = variable_get('user_terms_vocabs', array());

  // Merge all terms into one array
  $user_terms = array();
  foreach ($vids as $vid) {
    // Tags need special handling.
    if ($edit['user_terms_vids'][$vid] == 'tags') {
      // Free tags come in a string without tids
      $input_tags = drupal_explode_tags($edit['user_terms_' . $vid]);
      
      foreach ($input_tags as $input_tag) {
        // See if the term exists in the chosen vocabulary
        // and return the tid; otherwise, add a new record.
        $possibilities = taxonomy_get_term_by_name($input_tag);
        $input_tag_tid = NULL; // tid match, if any.
        foreach ($possibilities as $possibility) {
          if ($possibility->vid == $vid) {
            $input_tag_tid = $possibility->tid;
          }
        }

        if (!$input_tag_tid) {
          $t = array('vid' => $vid, 'name' => $input_tag);
          $status = taxonomy_save_term($t);
          $input_tag_tid = $t['tid'];
        }

        $user_terms[] = $input_tag_tid;
      }
    }
    else {
      // Depending on the type of field widget, this may be an array or a string.
      if (is_array($edit['user_terms_' . $vid])) {
        $user_terms = array_merge($user_terms, (array)$edit['user_terms_' . $vid]);
      }
      else {
        $user_terms[] = $edit['user_terms_' . $vid];
      }
    }
    $edit['user_terms_' . $vid] = NULL;
  }

  // Add into the array the terms already on the account from the vocabularies
  // we did NOT edit: otherwise they will be clobbered by the saving.
  $unedited_vids = array_diff($vids, $edited_vids);
  foreach ($account->user_terms as $tid => $term) {
    if (isset($unedited_vids[$term['vid']])) {
      $user_terms[] = $tid;
    }
  }

  // Clear existing if not inserting.
  if (!$register) {
    $query = "DELETE FROM {term_user} WHERE uid = %d";
    db_query($query, $account->uid);
  }

  // Persist the new data.
  $query = "INSERT INTO {term_user} (uid, tid) VALUES (%d, %d)";

  // Save all terms (except zeros).
  foreach (array_filter($user_terms) as $tid) {
    db_query($query, $account->uid, $tid);
  }
}

/**
 * Implementation of hook_form_FORM_ID_alter() for taxonomy_form_vocabulary.
 *
 * Add a (fake, disabled) checkbox on the vocabulary admin form to indicate
 * whether it is also applied to users.
 */
function user_terms_form_taxonomy_form_vocabulary_alter(&$form, &$form_state) {
  $vids = variable_get('user_terms_vocabs', array());

  $description = t('Checked if users can be categorized using this vocabulary.');
  if (user_access('administer users')) {
    $description .= ' ' . t('This can be edited on the <a href="@url">user terms settings page</a>.', array(
      '@url' => url('admin/user/user_terms'),
    ));   
  }
  $form['content_types']['users'] = array(
    '#type' => 'checkbox',
    '#title' => t('Users'),
    '#description' => $description,
    '#disabled' => TRUE,
    '#default_value' => isset($vids[$form['vid']['#value']]),
  );
}

/**
 * Implementation of hook_theme().
 */
function user_terms_theme($existing, $type, $theme, $path) {
  return array(
    'user_terms_settings' => array(
      'arguments' => array('form' => NULL),
      'file' => 'user_terms.admin.inc',
    )
  );
}


/**
 * Implementation of hook_views_api().
 */
function user_terms_views_api() {
  return array(
    'api' => 2,
    'path' => drupal_get_path('module', 'user_terms'),
  );
}
